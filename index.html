<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>assignment4</title>
</head>

<body class="container mt-4">
    
    <form>
        <h4>학생 관리 (조회/수정/삭제)</h4>
        
        MockAPI ID: <input type="text" id="mockapi_id" placeholder="MockAPI ID (1, 2, 3...)"><br>
        
        student number: <input type="text" id="view_student_id" placeholder="student_id (가져오기 시 표시됨)" disabled><br>

        name: <input type="text" id="student_name" placeholder="name"><br>
        age: <input type="number" id="student_age" placeholder="age"><br>
        grade:
        <select id="student_grade">
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
        </select><br>

        <button type="button" id="update_btn" class="btn btn-warning mt-2">학생데이터 수정</button>
        <button type="button" id="delete_btn" class="btn btn-danger mt-2">학생데이터 삭제</button>
        <button type="button" id="detail_btn" class="btn btn-info mt-2">학생데이터 가져오기</button>
    </form>
    
    <hr>

    <button type="button" id="add_modal_trigger_btn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">
        학생데이터 추가 (Modal)
    </button>
    <button type="button" id="list_btn" class="btn btn-primary">전체 학생 목록 보기</button>
    
    <hr>
    
    <div id="student_list_result">
        </div>

    
    <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 학생 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add_form">
                        name: <input type="text" id="add_student_name" placeholder="name" class="form-control"><br>
                        age: <input type="number" id="add_student_age" placeholder="age" class="form-control"><br>
                        student number: <input type="text" id="add_student_id" placeholder="student_id" class="form-control"><br>
                        grade:
                        <select id="add_student_grade" class="form-select">
                            <option>A</option>
                            <option>B</option>
                            <option>C</option>
                            <option>D</option>
                        </select><br>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" id="save_add_btn" class="btn btn-primary">저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function() {

            // MockAPI URL
            const MOCKAPI_URL = "https://6915289384e8bd126af8d850.mockapi.io/student";

            // "전체 학생 목록 보기" 기능
            $("#list_btn").click(function() {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", MOCKAPI_URL);
                xhr.send();
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const students = JSON.parse(xhr.response);
                        let html = '<table class="table">';
                        html += '<tr><th>MockAPI ID</th><th>Student ID</th><th>Name</th><th>Age</th><th>Grade</th></tr>';
                        students.forEach(s => {
                            html += `<tr><td>${s.id}</td><td>${s.student_id}</td><td>${s.name}</td><td>${s.age}</td><td>${s.student_grade}</td></tr>`;
                        });
                        html += '</table>';
                        $("#student_list_result").html(html);
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });


            // "학생 데이터 추가" 기능
            $("#save_add_btn").click(function() {
                alert("add student?");
                const xhr = new XMLHttpRequest();
                
                // [수정됨] 따옴표 제거 ("MOCKAPI_URL" -> MOCKAPI_URL)
                xhr.open("POST", MOCKAPI_URL); 
                xhr.setRequestHeader("content-type", "application/json");
            
                let data = {
                    name: $("#add_student_name").val(),
                    age: $("#add_student_age").val(), 
                    student_id: $("#add_student_id").val(),
                    student_grade: $("#add_student_grade").val()
                }
                xhr.send(JSON.stringify(data));
                xhr.onload = () => {
                    if (xhr.status === 201) { 
                        const res = JSON.parse(xhr.response);
                        alert(JSON.stringify(res));
                        var myModal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                        myModal.hide();
                        $("#list_btn").click(); 
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });


            // "학생 데이터 수정" 기능
            $("#update_btn").click(function() {
                alert("update student?");
                
                // [수정됨] MockAPI ID 전용 입력칸(#mockapi_id)에서 ID를 가져옴
                const idToUpdate = $("#mockapi_id").val(); 
                if (!idToUpdate) {
                    alert("MockAPI ID를 입력하세요.");
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open("PUT", MOCKAPI_URL + "/" + idToUpdate); 
                xhr.setRequestHeader("content-type", "application/json");
                
                let data = {
                    name: $("#student_name").val(),
                    age: $("#student_age").val(),
                    // [수정됨] 학번(student_id)은 'view_student_id' 값으로 유지 (수정되지 않음)
                    student_id: $("#view_student_id").val(), 
                    student_grade: $("#student_grade").val()
                };                
                
                xhr.send(JSON.stringify(data));
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        let res = JSON.parse(xhr.response);
                        alert(JSON.stringify(res));
                        $("#list_btn").click(); 
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });

            // "학생 데이터 삭제" 기능
            $("#delete_btn").click(function() {
                alert("delete student?");

                // [수정됨] MockAPI ID 전용 입력칸(#mockapi_id)에서 ID를 가져옴
                const idToDelete = $("#mockapi_id").val(); 
                if (!idToDelete) {
                    alert("MockAPI ID를 입력하세요.");
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open("DELETE", MOCKAPI_URL + "/" + idToDelete); 
                xhr.setRequestHeader("content-type", "application/json");
                xhr.send();
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        alert("삭제 성공");
                        // 폼 초기화
                        $("#mockapi_id").val('');
                        $("#view_student_id").val('');
                        $("#student_name").val('');
                        $("#student_age").val('');
                        
                        $("#list_btn").click(); 
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });

            // "학생 데이터 가져오기" 기능
            $("#detail_btn").click(function() {
                alert("detail student?");

                // [수정됨] MockAPI ID 전용 입력칸(#mockapi_id)에서 ID를 가져옴
                const idToFetch = $("#mockapi_id").val(); 
                if (!idToFetch) {
                    alert("MockAPI ID를 입력하세요.");
                    return;
                }
                
                const xhr = new XMLHttpRequest();
                xhr.open("GET", MOCKAPI_URL + "/" + idToFetch); 
                xhr.setRequestHeader("content-type", "application/json");
                xhr.send();
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        let res = JSON.parse(xhr.response);

                        // 데이터를 각 폼에 채워넣기
                        $("#student_name").val(res.name);
                        $("#student_age").val(res.age);
                        $("#student_grade").val(res.student_grade);
                        
                        // [수정됨] 학번은 'view_student_id' (disabled) 칸에 표시
                        $("#view_student_id").val(res.student_id); 
                        
                        // 'mockapi_id' 칸은 그대로 유지됨
                        
                        alert("데이터를 폼에 불러왔습니다.");
                        
                    } else {
                        console.log(xhr.status, xhr.statusText);
                        alert("데이터 조회에 실패했습니다.");
                    }
                }
            });
        });
    </script>
</body>

</html>